---
sidebar: sidebar 
permalink: backup/anf-cba-cloud-backup-for-applications-architecture.html 
keywords: applications, anf, strategy, data protection, backup 
summary: Cloud Backup for Applications是SaaS解決方案、可為NetApp雲端儲存設備上執行的應用程式提供資料保護功能。在NetApp BlueXP中啟用的雲端應用程式備份、可針對SAP HANA Azure NetApp Files 提供高效、應用程式一致且以原則為基礎的保護功能。Cloud Backup for Applications提供集中化的控制與監督、同時委派使用者管理應用程式專屬的備份與還原作業的能力。 
---
= 適用於應用程式的雲端備份架構
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/


link:anf-cba-use-cases-and-value-of-accelerated-backup-and-cloning-operations_overview.html["上一篇：適用於應用程式的雲端備份架構總覽。"]

[role="lead"]
Cloud Backup for Applications是SaaS解決方案、可為NetApp雲端儲存設備上執行的應用程式提供資料保護功能。在NetApp BlueXP中啟用的雲端應用程式備份、可針對SAP HANA Azure NetApp Files 提供高效、應用程式一致且以原則為基礎的保護功能。Cloud Backup for Applications提供集中化的控制與監督、同時委派使用者管理應用程式專屬的備份與還原作業的能力。

Cloud Backup for Applications在NetApp BlueXP內以SaaS形式執行、並運用架構和UI。BlueXP工作環境架構可用來設定及管理Azure NetApp Files 用於支援的認證資料。

必須在客戶vNet內部署BlueXP連接器。NetApp SaaS元件與客戶環境之間的通訊只能透過連接器進行。連接器使用ANF管理API執行ANF儲存作業。

HANA外掛程式提供HANA資料庫專屬邏輯、必須部署在每個HANA主機上。HANA外掛程式使用HANA hdbsqll用戶端和使用者存放區金鑰、與HANA資料庫進行通訊。所有資料庫作業都是由BlueXP連接器觸發。

image:anf-cba-image5.png["此影像說明NetApp SaaS搭配客戶網路和Azure訂閱的基本架構。"]



== 適用於SAP HANA的雲端備份



=== 解決方案總覽

Cloud Backup for Application支援下列元件的Snapshot型備份作業：

. * SAP HANA system*資料磁碟區。
. * SAP HANA資料庫的非資料磁碟區*。例如、 `/hana/shared` Volume和（或）SAP應用程式伺服器資料。
. *不屬於特定HANA系統的全域非資料磁碟區*。例如、SAP傳輸目錄 `/usr/sap/trans`。


這些元件的備份作業包括：

* 排程或隨需備份
* 選用的指令碼前與後置處理
* 原則導向的保留管理
+
** 適用於ANf-Volume層級的Snapshot
** SAP HANA備份目錄（適用於HANA資料Volume備份）




SAP HANA檔案型備份可用於資料庫區塊完整性檢查、也可隨需執行或排程備份作業。原則導向的保留管理是在檔案系統層級和HANA備份目錄中執行。

HANA資料庫記錄備份的保留管理是根據HANA資料庫資料備份（Snapshot或檔案型）的定義保留來執行。

CBA支援所有Snapshot型備份的還原作業。檔案型備份只能使用原生HANA工具還原。

image:anf-cba-image6.png["此映像描述HANA系統多租戶資料庫容器和全域非資料磁碟區的備份與還原。"]



=== 解決方案營運

Snapshot資料備份是透過Cloud Backup for Applications執行、方法是觸發SAP HANA資料庫備份儲存點、以便在儲存層上建立的Snapshot複本、以SAP HANA資料庫的一致映像為基礎。請參閱 https://help.sap.com/docs/SAP_HANA_PLATFORM/6b94445c94ae495c83a19646e7c3fd56/b41a2823576f4726be649bc98e61d62c.html?q=sap%20hana%20snapshot%20backup["SAP系統管理指南"^] 以取得更多資訊。

為了完整備份所有SAP HANA相關資源、Cloud Backup for Applications也可讓您使用儲存型Snapshot複本來備份所有非資料磁碟區。您可以從資料庫資料備份獨立排程非資料磁碟區、以啟用個別的保留與保護原則。

SAP建議結合儲存型Snapshot備份與每週檔案型備份、以執行區塊完整性檢查。您可以從CBA內部執行區塊完整性檢查。區塊完整性檢查（檔案型）備份也可用於將備份卸載到第二個儲存位置。

Cloud Backup for Applications會根據您可設定的保留原則、管理資料備份、記錄備份及SAP HANA備份目錄的管理作業。

下圖摘要說明備份解決方案。

image:anf-cba-image7.png["本圖摘要說明備份解決方案。"]

執行非資料磁碟區的儲存型Snapshot備份時、Cloud Backup for Applications會執行下列工作：

. 建立非資料磁碟區的儲存Snapshot複本。
. 根據定義的保留原則刪除儲存Snapshot複本。


執行SAP HANA資料庫的儲存型Snapshot備份時、Cloud Backup for Applications會執行下列工作：

. 建立SAP HANA備份儲存點、在持續層上建立一致的映像。
. 建立資料磁碟區的儲存Snapshot複本。
. 在SAP HANA備份目錄中登錄儲存Snapshot備份。
. 發佈SAP HANA備份儲存點。
. 根據定義的保留原則刪除儲存Snapshot複本。
. 根據定義的保留原則刪除SAP HANA備份目錄項目。
. 每當手動刪除資料備份或根據保留原則刪除資料備份時、Cloud Backup for Applications會刪除所有早於最舊資料備份的記錄備份。記錄備份會在檔案系統和SAP HANA備份目錄中刪除。




=== 支援的SAP HANA版本與組態

Cloud Backup for Applications可透過下列組態選項、以單一或多個租戶支援HANA MDC系統：

* SAP HANA 2.0 SPS4及更新版本
* SAP HANA單一主機系統
* 如一節所述、SAP HANA多主機系統 link:anf-cba-backup-operations-with-hana-system-replication.html#backup-operations-with-hana-multiple-host-systems["「使用HANA多主機系統進行備份作業」"]
* SAP HANA系統設定HANA系統複寫（HSR）、如一節所述 link:anf-cba-backup-operations-with-hana-system-replication.html["「採用HANA系統複寫的備份作業」"]




== 雲端備份應用程式概念與最佳實務做法



=== 資料保護策略

在為應用程式設定Cloud Backup之前、您必須根據各種SAP系統的RTO和RPO需求來定義資料保護策略。

常見的方法是定義系統類型、例如正式作業、開發、測試或沙箱系統。同一系統類型的所有SAP系統通常具有相同的資料保護參數。

您必須定義下列參數：

* Snapshot備份的執行頻率
* Snapshot備份保留多久
* 執行區塊完整性檢查（檔案型備份）的頻率
* 保留區塊完整性檢查備份（檔案型備份）的時間


下表顯示系統類型之正式作業、開發及測試的資料保護參數範例。對於正式作業系統、已定義高備份頻率、並會執行每週檔案型備份。測試與開發系統的需求較低、而且Snapshot備份的排程頻率較低。

|===
| 參數 | 正式作業系統 | 開發系統 | 測試系統 


| Snapshot備份頻率 | 每4小時 | 每6小時 | 每12小時 


| Snapshot備份保留 | 3天 | 3天 | 3天 


| 區塊完整性檢查頻率 | 每週一次 | 每週一次 | 每週一次 


| 區塊完整性檢查保留 | 4週 | 2週 | 1週 
|===
下表顯示必須針對Snapshot備份作業的資料保護參數設定的原則。

|===
| 參數 | 原則SnapshotEvery4H | 原則快照每6小時 | 原則SnapshotEvery12h 


| 備份類型 | 快照型 | 快照型 | 快照型 


| 排程類型 | 每小時 | 每小時 | 每小時 


| 保留 | 計數= 18 | 計數= 12 | 計數= 3 


| 備份排程 | 每4小時 | 每6小時 | 每12小時 
|===
下表顯示必須針對檔案型備份作業的資料保護參數設定的原則。

|===
| 參數 | 原則檔案Based4Week | 原則檔案Based2Weeks | 原則FileBased1Week 


| 備份類型 | 檔案型 | 檔案型 | 檔案型 


| 排程類型 | 每週 | 每週 | 每週 


| 保留 | 計數= 4 | 計數= 2 | 計數= 1 


| 備份排程 | 每週日 | 每週日 | 每週日 
|===


== 備份作業

SAP在採用HANA 2.0 SPS4的多租戶系統中推出Snapshot備份支援。在SAP HANA MDC系統中、租戶組態不一定是靜態的。您可以新增或刪除租戶。Cloud Backup for Applications無法仰賴HANA資料庫新增至Cloud Backup for Applications時所發現的組態。雲端備份應用程式必須知道在執行備份作業時、哪些租戶可用。

因此、在每次備份作業中、工作流程的第一步是取得租戶資訊。下一步是Snapshot備份作業本身。此步驟包括觸發HANA備份儲存點、anf Snapshot備份的SQL命令、以及關閉HANA備份儲存點的SQL命令。HANA資料庫會使用Close命令、更新系統資料庫和每個租戶的備份目錄。


NOTE: 當一或多個租戶停止運作時、SAP HANA不支援針對MDC系統進行Snapshot備份作業。

為了保留資料備份與HANA備份目錄管理、Cloud Backup for Applications必須針對系統資料庫和第一步中識別的所有租戶資料庫執行目錄刪除作業。以記錄備份的相同方式、Cloud Backup for Applications工作流程必須在備份作業的每個租戶上運作。

下圖顯示備份工作流程的總覽。

image:anf-cba-image8.png["此圖顯示備份工作流程的總覽。"]



=== HANA資料庫Snapshot備份的備份工作流程

Cloud Backup for Applications會依下列順序備份SAP HANA資料庫：

. Cloud Backup for Applications會從HANA資料庫讀取租戶清單。
. 租戶資訊儲存在Cloud Backup for Applications中繼資料中、以供備份作業使用。
. Cloud Backup for Applications會觸發SAP HANA全域同步備份儲存點、以便在持續層上建立一致的資料庫映像。
+

NOTE: 對於SAP HANA MDC單租戶或多租戶系統、系統資料庫和每個租戶資料庫的同步化全域備份儲存點都是以單一作業建立。

. Cloud Backup for Applications會為HANA系統設定的所有資料磁碟區建立Anf Snapshot複本。對於單一主機HANA資料庫、只有一個資料Volume。有了SAP HANA多主機資料庫、就有多個資料磁碟區。
. Cloud Backup for Applications會在SAP HANA備份目錄中註冊Snapshot備份。
. Cloud Backup for Applications會刪除SAP HANA備份儲存點。
. Cloud Backup for Applications會根據為備份所定義的保留原則、刪除資料庫及SAP HANA備份目錄中的ANF Snapshot複本和備份項目。Hana備份目錄作業是針對系統資料庫和所有租戶執行。
. Cloud Backup for Applications會刪除檔案系統和SAP HANA備份目錄中的所有記錄備份、這些記錄備份的版本比SAP HANA備份目錄中識別的最舊成功資料備份還舊。這些作業是針對系統資料庫和所有租戶執行。




=== 區塊完整性檢查作業的備份工作流程

Cloud Backup for Applications會依照下列順序執行區塊完整性檢查：

. Cloud Backup for Applications會從HANA資料庫讀取租戶清單。
. Cloud Backup for Applications會觸發系統資料庫和每個租戶的檔案型備份作業。
. Cloud Backup for Applications會根據針對區塊完整性檢查作業所定義的保留原則、刪除資料庫、檔案系統和SAP HANA備份目錄中的檔案型備份。系統資料庫和所有租戶都會在檔案系統和HANA備份目錄作業上執行備份刪除。
. Cloud Backup for Applications會刪除檔案系統和SAP HANA備份目錄中的所有記錄備份、這些記錄備份的版本比SAP HANA備份目錄中識別的最舊資料備份還要舊。這些作業是針對系統資料庫和所有租戶執行。




== 資料與記錄備份的備份保留管理與管理

資料備份保留管理與記錄備份管理可分為四大領域、包括下列項目的保留管理：

* Snapshot備份
* 檔案型備份
* SAP HANA備份目錄中的資料備份
* 在SAP HANA備份目錄和檔案系統中記錄備份


下圖概述不同的工作流程、以及每項作業的相依性。以下各節將詳細說明不同的作業。

image:anf-cba-image9.png["本圖概述不同的工作流程、以及每項作業的相依性。"]



=== Snapshot備份的保留管理

Cloud Backup for Applications會根據Cloud Backup for Applications備份原則中所定義的保留、刪除儲存設備和Cloud Backup for Applications儲存庫中的Snapshot複本、以處理SAP HANA資料庫備份和非資料磁碟區備份的管理工作。

保留管理邏輯會隨著Cloud Backup for Applications中的每個備份工作流程執行。

您也可以在Cloud Backup for Applications中手動刪除Snapshot備份。



=== 檔案型備份的保留管理

Cloud Backup for Applications會根據Cloud Backup for Applications備份原則中所定義的保留、刪除檔案系統上的備份、以處理檔案型備份的管理工作。

保留管理邏輯會隨著Cloud Backup for Applications中的每個備份工作流程執行。



=== SAP HANA備份目錄中的資料備份保留管理

當Cloud Backup for Applications刪除任何備份（Snapshot或檔案型）時、SAP HANA備份目錄中也會刪除此資料備份。



=== 記錄備份的保留管理

SAP HANA資料庫會自動建立記錄備份。這些記錄備份執行會在SAP HANA設定的備份目錄中、為每個SAP HANA服務建立備份檔案。

如果要進行轉送恢復、不再需要使用早於最舊成功的資料備份的記錄備份、因此可以刪除。

Cloud Backup for Applications會執行下列步驟、在檔案系統層級和SAP HANA備份目錄中、處理記錄檔備份的管理工作：

* Cloud Backup for Applications會讀取SAP HANA備份目錄、以取得最舊且成功的檔案型或Snapshot備份的備份ID。
* Cloud Backup for Applications會刪除SAP HANA目錄和檔案系統中所有早於此備份ID的記錄備份。



NOTE: 雲端備份應用程式只會處理雲端備份應用程式所建立的備份作業。如果在Cloud Backup for Applications之外建立任何其他資料備份、您必須確定已從備份目錄中刪除資料備份。如果這類資料備份並未從備份目錄手動刪除、則可能會成為最舊的資料備份、而且在刪除此資料備份之前、不會刪除舊的記錄備份。


NOTE: 預設會啟用記錄備份管理功能、但可在HANA外掛程式主機層級停用。編輯 `hana.property` 檔案 `/opt/NetApp/snapcenter/scc/etc`。包括參數 `LOG_CLEANUP_DISABLE = Y` 在中 `hana.property` 組態檔會停用記錄備份管理功能。如果檔案不存在、您必須建立該檔案。



== 實現與HANA資料庫的安全通訊

如果HANA資料庫設定為安全通訊 `hdbsql` 由CBA執行的命令必須使用其他命令列選項。這可以透過使用呼叫的包裝指令碼來達成 `hdbsql` 提供所需選項。


NOTE: 有多種選項可用來設定SSL通訊。在下列範例中、最簡單的用戶端組態是使用命令列選項來說明、而不會驗證伺服器憑證。如果需要在伺服器和/或用戶端進行憑證驗證、則需要不同的hdbsql命令列選項、而且您必須依照《SAP HANA安全性指南》中的說明來設定PSE環境。

而非設定 `hdbsql` 中的執行檔 `hana.properties` 檔案中、您可以新增包裝指令碼。在檔案中 `/opt/NetApp/snapcenter/scc/etc/hana.properties`、您必須新增下列內容。如果檔案不存在、您必須建立該檔案。

此範例適用於SID=SM1且執行個體編號為12的HANA系統。

....
HANA_HDBSQL_CMD = /usr/sap/SM1/HDB12/exe/hdbsqls
....
包裝程序指令碼「hdbsqls」會使用必要的命令列選項來呼叫「hdbsql」。

....
#/bin/bash
/usr/sap/SM1/HDB12/exe/hdbsql -e -ssltrustcert $*
....


== Snapshot備份的容量需求

您必須考量儲存層的區塊變更率、相對於傳統資料庫的變更率。由於資料行儲存區的HANA表格合併程序、完整的資料表會寫入磁碟、而不只是資料表中的變更資料。

如果一天內進行多個Snapshot備份、則客戶群的資料顯示每日變更率介於20%到50%之間。

link:anf-cba-overview-of-installation-and-configuration-steps.html["下一步：安裝與組態步驟總覽。"]
